name: ABI Checks

on:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main

jobs:
  abicheck:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout baseline version (from upstream)
      uses: actions/checkout@v4
      with:
        repository: 'baresip/re'
        ref: 'v3.24.0'
        path: old

    - name: Checkout current version
      uses: actions/checkout@v4
      with:
        path: current

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        # Install Python and Conan for current version
        python -m pip install --upgrade pip
        pip install "conan>=2.0.0"
        # Install build tools and ABI analysis tools
        sudo apt-get update && sudo apt-get install -y \
          abigail-tools cmake ninja-build \
          libssl-dev zlib1g-dev build-essential

    - name: Setup Conan (for current version only)
      run: |
        conan remote add conancenter https://center2.conan.io --force
        conan profile detect --force

    - name: Build baseline version (v3.24.0) with CMake
      run: |
        cd old
        echo "Building baseline v3.24.0 with traditional CMake..."
        cmake -B build -DBUILD_SHARED_LIBS=ON -DCMAKE_BUILD_TYPE=Release -GNinja
        cmake --build build

        # Find the generated shared library
        echo "Searching for baseline shared libraries..."
        find build -name "*libre*" -type f | head -10

        BASELINE_LIB=$(find build -name "libre.so*" -type f | grep -v "\.a$" | sort | tail -1)

        if [ -z "$BASELINE_LIB" ]; then
          echo "No shared library found, searching more broadly..."
          BASELINE_LIB=$(find build -name "*.so*" -type f | head -1)
        fi

        echo "Found baseline library: $BASELINE_LIB"

        if [ -n "$BASELINE_LIB" ] && [ -f "$BASELINE_LIB" ]; then
          cp "$BASELINE_LIB" ../baseline-libre.so
        else
          echo "ERROR: Could not find baseline shared library"
          exit 1
        fi

    - name: Build current version (v4.0.0) with Conan
      run: |
        cd current
        echo "Building current v4.0.0 with Conan..."
        conan create . --build=missing -o libre/*:shared=True

        # Extract shared library from Conan package
        echo "Searching for Conan packaged libraries..."
        find ~/.conan2/p -path "*/libre/4.0.0/*" -name "*libre*" -type f | head -10

        # Find the main shared library (look for .so files, prefer versioned)
        CURRENT_LIB=$(find ~/.conan2/p -path "*/libre/4.0.0/*" -name "libre.so*" \
          -type f | grep -v "\.a$" | sort | tail -1)

        if [ -z "$CURRENT_LIB" ]; then
          echo "No shared library found, searching more broadly..."
          CURRENT_LIB=$(find ~/.conan2/p -path "*/libre/4.0.0/*" -name "*.so*" -type f | head -1)
        fi

        echo "Found current library: $CURRENT_LIB"

        if [ -n "$CURRENT_LIB" ] && [ -f "$CURRENT_LIB" ]; then
          cp "$CURRENT_LIB" ../current-libre.so
        else
          echo "ERROR: Could not find current shared library"
          exit 1
        fi

    - name: Verify libraries
      run: |
        echo "Verifying extracted libraries:"
        ls -la *.so
        file *.so
        echo ""
        echo "Library details:"
        ldd baseline-libre.so | head -5 || true
        ldd current-libre.so | head -5 || true

    - name: ABI compatibility check
      id: abidiff
      run: |
        echo "🔍 Performing ABI compatibility analysis..."
        echo "Baseline: libre v3.24.0 (built with CMake from upstream)"
        echo "Current:  libre v4.0.0 (built with Conan from fork)"
        echo ""

        # Run abidiff and capture output
        if abidiff baseline-libre.so current-libre.so; then
          echo "✅ ABI is compatible between versions"
          echo "abi_compatible=true" >> $GITHUB_OUTPUT
        else
          echo "⚠️ ABI changes detected"
          echo "abi_compatible=false" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true

    - name: ABI compatibility summary
      run: |
        echo "## 🔍 ABI Compatibility Analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Baseline Version:** libre v3.24.0 (built with CMake from upstream)" >> $GITHUB_STEP_SUMMARY
        echo "**Current Version:** libre v4.0.0 (built with Conan from fork)" >> $GITHUB_STEP_SUMMARY
        echo "**Build Methods:** Hybrid approach for maximum compatibility" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.abidiff.outputs.abi_compatible }}" = "true" ]; then
          echo "✅ **Result:** ABI compatibility maintained" >> $GITHUB_STEP_SUMMARY
          echo "::notice::ABI compatibility maintained between v3.24.0 and v4.0.0"
        else
          echo "⚠️ **Result:** ABI breaking changes detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Analysis:** This is expected for major version bumps (3.x → 4.x)" >> $GITHUB_STEP_SUMMARY
          echo "**Impact:** Applications using libre will need to be recompiled" >> $GITHUB_STEP_SUMMARY
          echo "**Action Required:** Update version dependencies in downstream projects" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "::warning::ABI breaking changes found - expected for major version bump (3.x → 4.x)"
          echo "::notice::For major version releases, ABI breaks are acceptable and expected"
        fi
