name: ABI Checks

on:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main

jobs:
  abicheck:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout baseline version (from upstream)
      uses: actions/checkout@v4
      with:
        repository: 'baresip/re'
        ref: 'v3.24.0'
        path: old

    - name: Checkout current version
      uses: actions/checkout@v4
      with:
        path: current

    - name: fix flaky azure mirrors
      if: ${{ runner.os == 'Linux' }}
      run: |
        sudo sed -i 's/azure\./de\./' /etc/apt/sources.list

    - name: install dependencies
      run: |
        sudo apt-get update && sudo apt-get install -y abigail-tools cmake ninja-build libssl-dev zlib1g-dev

    - name: build baseline shared library
      run: |
        cmake -S old -B old/build -DBUILD_SHARED_LIBS=ON -DCMAKE_BUILD_TYPE=Release -GNinja
        cmake --build old/build --target libre

    - name: build current shared library
      run: |
        cmake -S current -B current/build -DBUILD_SHARED_LIBS=ON -DCMAKE_BUILD_TYPE=Release -GNinja
        cmake --build current/build --target libre

    - name: find shared libraries
      run: |
        echo "Baseline library:"
        find old/build -name "*.so*" -type f | head -5
        echo "Current library:"
        find current/build -name "*.so*" -type f | head -5

    - name: abidiff compare
      id: abidiff
      run: |
        OLD_LIB=$(find old/build -name "libre.so*" -type f | head -1)
        NEW_LIB=$(find current/build -name "libre.so*" -type f | head -1)
        echo "Comparing: $OLD_LIB vs $NEW_LIB"
        abidiff "$OLD_LIB" "$NEW_LIB" || true
      continue-on-error: true

    - name: ABI compatibility summary
      run: |
        if [ "${{ steps.abidiff.outcome }}" = "success" ]; then
          echo "✅ ABI is compatible between v3.24.0 and current version"
          echo "::notice::ABI compatibility maintained"
        else
          echo "⚠️ ABI changes detected between v3.24.0 and current version (4.0.0)"
          echo "::warning::ABI breaking changes found - this is expected for major version bump (3.x → 4.x)"
          echo "::notice::For major version releases, ABI breaks are acceptable"
        fi
